---
title: "Reproducible Research: Peer Assessment 1"
author: "Derek Slone-Zhen"
date: "14th October 2014"
output: 
  html_document:
    keep_md: true
---

## Loading and preprocessing the data

The Activity monitoring data for this assignement is available directly at https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2Factivity.zip and is also available withing [this git repositorty](https://github.com/dereksz/RepData_PeerAssessment1).

The variables included in this dataset are:

* **steps**: Number of steps taking in a 5-minute interval (missing
    values are coded as `NA`)

* **date**: The date on which the measurement was taken in YYYY-MM-DD
    format

* **interval**: Identifier for the 5-minute interval in which
    measurement was taken

First, we must load the data, unzipping it first from the zip file:

```{r loaddata, cache=TRUE}
df <- read.csv(unz("activity.zip","activity.csv"), colClasses=c('integer','Date','integer'))
# Add a 'continuous' interval using decimal hours for better presentation on some graphs
interval_to_hour <- function(i) i %/% 100 + (i %% 100) / 60 
df$hour <- interval_to_hour(df$interval)
str(df) # Show structure
summary(df) # And summary stats for each column
# Now compute data set with NAs removed
df.na.rm <- df[!is.na(df$steps),] # df with NA steps removed
```

## What is mean total number of steps taken per day?

First, we calculate our daily summaries:

```{r daily}
df.daily <- aggregate(steps ~ date, data = df.na.rm, FUN=sum) # Summarised down to daily level
```

Plotting this, we can see a roughly normal distribution of the daily number of steps in the following histogram: 

```{r hist1}
g <- df.daily$steps
h <- hist(g, xlab='Steps', main="Histogram of Steps per Day",breaks=10)
# The normal fit is thank to http://stackoverflow.com/questions/20078107/overlay-normal-curve-to-histogram-in-r
xfit <- seq(min(g),max(g),length=100)
yfit <- dnorm(xfit,mean=mean(g),sd=sd(g)) 
multiplier <- h$counts / h$density
lines(xfit, yfit*multiplier[1], col="red", lwd=2)
```

Ignoring missing values, the mean number of steps taken per day, is `r mean(df.daily$steps)`, 
and the median number of steps taken per day is `r median(df.daily$steps)`.
These can be calculated individually as:

```{r mean_median}
mean(df.daily$steps)
median(df.daily$steps)
```

Or in combination using the `summary` function:

```{r nna_summary}
summary(df.daily$steps)
```
Finally, we can add these to our original plot, although the two values are so close you may not be able to 
differentiate the lines!

```{r hist2}
hist(g, xlab='Steps', main="Histogram of Steps per Day",breaks=10)
abline(v=mean(df.daily$steps, na.rm = TRUE),col='red')
abline(v=median(df.daily$steps, na.rm = TRUE),col='blue')
```

## (Additional) What is the overall trend over time?

Overall trend over time:

```{r overtime}
library(ggplot2)
plot.data=aggregate(steps ~ date, data=df.na.rm, FUN='mean')
qplot(x=date, y=steps, 
      data=plot.data, 
      geom='point',
      main="Avg Steps each day") +
  geom_smooth(method='lm',se=FALSE)
```

No real trend here.

Overall trend over time, coloured by day of week:

```{r overtime.by.day}
qplot(x=date, y=steps, 
      data=plot.data, 
      colour=weekdays(date), 
      geom='point',
      main="Avg Steps each day") +
  geom_smooth(method='lm',se=FALSE)
```

## What is the average daily activity pattern?

```{r intraday}
df.intra.day.average <- aggregate(steps ~ interval, data = df.na.rm, FUN=mean) # Summarised by interval
df.intra.day.average$hour <- interval_to_hour(df.intra.day.average$interval)
modal.pos <- which.max(df.intra.day.average$steps)
modal.hour <- df.intra.day.average$hour[modal.pos]
modal.interval <- df.intra.day.average$interval[modal.pos]
with(df.intra.day.average, {
  plot(x=hour, y=steps, type='l', main="Average Steps per Time Interval", xlab='Interval')
  abline(v=modal.hour,col='red')
})
```

The mode of the intra-day averages, indicating the 5-minute window with the maximum average number of steps, is `r modal.interval`, that is [08:35 ... 08:40) - that's probably everyone walking to work!

## Imputing missing values

### Establishing the shape of the missing values

Now calculate our intra-day summaries and plot:

First, let us create a data set denoting _just_ the missing values.


```{r missings}
df.missing <- df[is.na(df$steps),-1]
num.missing <- nrow(df.missing)
```

This shows us that there are `r num.missing` missing data points.
Next, see how many we have in total, and see if their is any discernable 'shape' to it.

```{r missings_plot}
library(ggplot2)
qplot(x=date, y=hour, data=df.missing, stat='identity', alpha=I(0.3), main="Scatter of missing values by date x interval") +
  scale_y_continuous(breaks=seq(0,24,by=3))
```

The plot suggests strongly that we have many missing values on a few specific days.
So we further summarise the missing into their day-groups to check the extent of this hypothesis.
(And add in the weekdays to see if that may also be a contributing factor.)

```{r missings.daily}
df.missing.by.day <- aggregate(interval ~ date, data = df.missing, FUN='length')
df.missing.by.day$weekday <- weekdays(df.missing.by.day$date,TRUE)
df.missing.by.day
```

We discover that the NAs actually apply to the whole of the day in which NAs occur
(there are 288 5-minute slices in 24-hours).  
That is, for a given day, we either have complete data or no data.

### Mechanisms for Imputing

The first obvious method of imputing would be to simply take the average for the interval across all days and use that
to impute the missing values identified above.  However, we already have a concern that there may be a systemic bias according to
the day of the week, and there may be a systemic up-ward or down-ward trend in the data that we have not yet determined.

We need to examine the data by date and by weekday to determine if our strategy is valid.

```{r impute.plot.1}
qplot(data=df[df$steps > 0,], x=hour, y=steps, colour=weekdays(date), alpha=I(0.7))
```
```{r impute.plot.2}
qplot(data=df[df$steps > 0,], x=date, y=hour, size=steps, colour=weekdays(date), alpha=I(0.5))
```

## Are there differences in activity patterns between weekdays and weekends?
